{{- with resources.Get "iife/main.js" }}
  {{- if hugo.IsProduction }}
    {{- with . | fingerprint }}
      <script
        defer
        src="{{ .RelPermalink }}"
        integrity="{{ .Data.Integrity }}"
      ></script>
    {{- end }}
  {{- else }}
    <script defer src="{{ .RelPermalink }}"></script>

    {{- with resources.Get "iife/main.js.map" }}
      <!--{{ .RelPermalink }}-->
    {{- end }}
  {{- end }}
{{- end }}

{{- if hugo.IsProduction }}
  <script type="module">
    window.addEventListener('load', () => {
      const script = document.createElement('script');
      script.setAttribute('src', 'https://cloud.umami.is/script.js');
      script.setAttribute('crossorigin', 'anonymous');
      script.setAttribute('data-website-id', '{{ site.Params.umami_id }}')
      document.head.appendChild(script);
    });
  </script>
{{- end }}


<!-- Get resources needed to highlight code blocks, after the page load -->
<script type="module">
  function loadCSS(src, cb) {
    fetch(src).then(async (response) => {
      const content = await response.text();
      const sheet = document.createElement('style');
      sheet.textContent = cb ? cb(content) : content;
      document.head.appendChild(sheet);
    });
  }

  window.addEventListener('load', () => {
    const CDN = 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1';

    import(`${CDN}/build/es/highlight.min.js`).then(({ default: hljs }) => {
      document.querySelectorAll('pre code').forEach((el) => {
        hljs.highlightElement(el);
      });

      loadCSS(`${CDN}/build/styles/github.css`, (content) => {
        return content.replace(/(^\.hljs|\s\.hljs)/g, '.light .hljs');
      });
      loadCSS(`${CDN}/build/styles/github-dark.css`, (content) => {
        return content.replace(/(^\.hljs|\s\.hljs)/g, '.dark .hljs');
      });
    });
  });
</script>
