{{- with resources.Get "iife/main.js" }}
  {{- if hugo.IsProduction }}
    {{- with . | fingerprint }}
      <script
        defer
        src="{{ .RelPermalink }}"
        integrity="{{ .Data.Integrity }}"
      ></script>
    {{- end }}
  {{- else }}
    <script defer src="{{ .RelPermalink }}"></script>

    {{- with resources.Get "iife/main.js.map" }}
      <!--{{ .RelPermalink }}-->
    {{- end }}
  {{- end }}
{{- end }}

{{- if hugo.IsProduction }}
  <script type="module">
    window.addEventListener('load', () => {
      const script = document.createElement('script');
      script.setAttribute('src', 'https://cloud.umami.is/script.js');
      script.setAttribute('crossorigin', 'anonymous');
      script.setAttribute('data-website-id', '{{ site.Params.umami_id }}')
      document.head.appendChild(script);
    });
  </script>
{{- end }}

{{- with resources.Get "workers/prettier.js" }}

  <!-- Get resources needed to highlight code blocks, after the page load -->
<script type="module">
  function loadCSS(src, cb) {
    fetch(src).then(async (response) => {
      const content = await response.text();
      const sheet = document.createElement('style');
      sheet.textContent = cb ? cb(content) : content;
      document.head.appendChild(sheet);
    });
  }

  window.addEventListener('load', () => {
    const worker = new Worker('{{ .RelPermalink }}');

    let workerLastActive = performance.now();

    const workerOnMessage = ({ data }) => {
      if (data.error) return;
      const code = document.getElementById(data.id);
      if (code) code.innerHTML = data.highlightedCode;

      workerLastActive = performance.now();
    }

    worker.addEventListener('message', workerOnMessage);

    // Terminate the worker after 10s of inactivity
    const interval = setInterval(() => {
      if (performance.now() - workerLastActive >= 10e3) {
        worker.terminate();
        worker.removeEventListener('message', workerOnMessage);
        clearInterval(interval);
      }
    }, 1000);

    const selectors = {
      'html': 'pre code.language-xml, pre code.language-html',
      'javascript': 'pre code.language-javascript',
    };

    for (const language in selectors) {
      document.querySelectorAll(selectors[language]).forEach(code => {
        code.id ||= Math.random().toString(16).slice(2);
        worker.postMessage({id:code.id,code: code.textContent, language});
      });
    }


    const CDN = 'https://unpkg.com/@highlightjs/cdn-assets@11.11.1';

    loadCSS(`${CDN}/styles/github.css`, (content) => {
      return content.replace(/(^\.hljs|\s\.hljs)/g, '.light .hljs');
    });
    loadCSS(`${CDN}/styles/github-dark.css`, (content) => {
      return content.replace(/(^\.hljs|\s\.hljs)/g, '.dark .hljs');
    });
  });
</script>
{{- end }}
